name: SonarCloud analysis and create Jira issues

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  analyze:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis

      - name: Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      # Use v3 for latest features and Java 17 support
      - name: Run SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=I-Macharia_wk-6-shakl
            -Dsonar.organization=i-macharia
            -Dsonar.sources=src,public
            -Dsonar.tests=tests
            -Dsonar.exclusions=**/node_modules/**,**/build/**,**/dist/**,**/coverage/**,**/*.test.js,**/*.spec.js
            -Dsonar.test.exclusions=**/node_modules/**,**/*.test.js,**/*.spec.js
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
            -Dsonar.qualitygate.wait=true


  create-jira-issues:
    name: Create Jira Issues
    needs: analyze
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Wait for SonarCloud processing
        run: |
          echo "Waiting 45 seconds for SonarCloud to process analysis results..."
          sleep 45

      - name: Fetch SonarCloud issues and create Jira tickets
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_KEY: I-Macharia_wk-6-shakl
          JIRA_HOST: ${{ secrets.JIRA_HOST }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_PROJECT_KEY: ${{ secrets.JIRA_PROJECT_KEY }}
        run: |
          set -euo pipefail
          
          # ==========================================
          # USER CONFIGURATION
          # ==========================================
          JIRA_ENV_OPTION="Chrome"
          # ==========================================

          echo "=========================================="
          echo "SonarCloud to Jira Issue Sync"
          echo "=========================================="
          echo "Project: ${SONAR_PROJECT_KEY}"
          echo "Jira Project: ${JIRA_PROJECT_KEY}"
          echo ""

          SONAR_API="https://sonarcloud.io/api/issues/search"
          PARAMS="componentKeys=${SONAR_PROJECT_KEY}&resolved=false&types=VULNERABILITY,BUG,CODE_SMELL&ps=500"

          echo "ðŸ“Š Fetching issues from SonarCloud..."
          issues_json=$(curl -s -u "${SONAR_TOKEN}:" "${SONAR_API}?${PARAMS}")

          # Check for API errors
          if echo "$issues_json" | jq -e '.errors' > /dev/null 2>&1; then
            echo "âŒ SonarCloud API Error:"
            echo "$issues_json" | jq '.errors'
            exit 1
          fi

          total=$(echo "$issues_json" | jq -r '.total // 0')
          echo "âœ“ Found $total unresolved SonarCloud issues"
          echo ""

          if [ "$total" -eq 0 ]; then
            echo "âœ… No unresolved issues found. Exiting successfully."
            exit 0
          fi

          created=0
          skipped=0
          failed=0

          echo "$issues_json" | jq -c '.issues[]' | while IFS= read -r issue; do
            issue_key=$(echo "$issue" | jq -r '.key')
            rule=$(echo "$issue" | jq -r '.rule')
            severity=$(echo "$issue" | jq -r '.severity')
            type=$(echo "$issue" | jq -r '.type')
            comp=$(echo "$issue" | jq -r '.component')
            file=$(echo "$issue" | jq -r '.component' | sed 's/.*://')
            line=$(echo "$issue" | jq -r '.line // "n/a"')
            message=$(echo "$issue" | jq -r '.message')
            sonar_link="https://sonarcloud.io/project/issues?id=${SONAR_PROJECT_KEY}&open=${issue_key}"
            summary="[SonarCloud ${type}] ${severity}: ${rule} in ${file}"

            # Escape special characters for JSON
            message_escaped=$(echo "$message" | jq -Rs .)
            
            # Jira description in JSON
            description=$(jq -n \
              --arg ik "$issue_key" \
              --arg rl "$rule" \
              --arg sv "$severity" \
              --arg tp "$type" \
              --arg fl "$file" \
              --arg ln "$line" \
              --argjson msg "$message_escaped" \
              --arg sl "$sonar_link" \
              '{
                "type": "doc",
                "version": 1,
                "content": [
                  {
                    "type": "heading",
                    "attrs": {"level": 3},
                    "content": [{"type": "text", "text": "SonarCloud Issue Details"}]
                  },
                  {
                    "type": "paragraph",
                    "content": [
                      {"type": "text", "text": "Issue Key: ", "marks": [{"type": "strong"}]},
                      {"type": "text", "text": $ik}
                    ]
                  },
                  {
                    "type": "paragraph",
                    "content": [
                      {"type": "text", "text": "Rule: ", "marks": [{"type": "strong"}]},
                      {"type": "text", "text": $rl}
                    ]
                  },
                  {
                    "type": "paragraph",
                    "content": [
                      {"type": "text", "text": "Severity: ", "marks": [{"type": "strong"}]},
                      {"type": "text", "text": $sv}
                    ]
                  },
                  {
                    "type": "paragraph",
                    "content": [
                      {"type": "text", "text": "Type: ", "marks": [{"type": "strong"}]},
                      {"type": "text", "text": $tp}
                    ]
                  },
                  {
                    "type": "paragraph",
                    "content": [
                      {"type": "text", "text": "File: ", "marks": [{"type": "strong"}]},
                      {"type": "text", "text": ($fl + ":" + $ln)}
                    ]
                  },
                  {
                    "type": "heading",
                    "attrs": {"level": 3},
                    "content": [{"type": "text", "text": "Issue Description"}]
                  },
                  {
                    "type": "paragraph",
                    "content": [{"type": "text", "text": $msg}]
                  },
                  {
                    "type": "paragraph",
                    "content": [
                      {"type": "text", "text": "View in SonarCloud: ", "marks": [{"type": "strong"}]},
                      {
                        "type": "text",
                        "text": $sl,
                        "marks": [{"type": "link", "attrs": {"href": $sl}}]
                      }
                    ]
                  }
                ]
              }')

            # Check if Jira issue already exists
            search_jql=$(printf 'text ~ "%s" ORDER BY created DESC' "$issue_key" | jq -sRr @uri)
            search_url="https://${JIRA_HOST}/rest/api/3/search?jql=${search_jql}&fields=key,summary"
            
            existing=$(curl -s -u "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
              -H "Accept: application/json" \
              "${search_url}" 2>/dev/null || echo '{"total":0}')

            existing_total=$(echo "$existing" | jq -r '.total // 0')
            
            if [ "$existing_total" != "0" ]; then
              existing_key=$(echo "$existing" | jq -r '.issues[0].key // "unknown"')
              echo "  â­ï¸  Jira issue ${existing_key} exists for ${issue_key} - skipping"
              ((skipped++)) || true
              continue
            fi

            # --- MAPPING LOGIC START ---

            # 1. Priority (Standard Jira field)
            case "$severity" in
              BLOCKER|CRITICAL) priority="Highest" ;;
              MAJOR) priority="High" ;;
              MINOR) priority="Medium" ;;
              INFO) priority="Low" ;;
              *) priority="Medium" ;;
            esac

            # 2. Issue Type
            issue_type="Bug"

            # 3. Severity Custom Field (customfield_10042)
            # Mapped to match your options: Critical, Major, Minor, Cosmetic
            case "$severity" in
              BLOCKER) jira_severity="Critical" ;;
              CRITICAL) jira_severity="Critical" ;;
              MAJOR) jira_severity="Major" ;;
              MINOR) jira_severity="Minor" ;;
              INFO) jira_severity="Cosmetic" ;;
              *) jira_severity="Major" ;;
            esac
            
            # --- MAPPING LOGIC END ---

            steps_to_reproduce=$(jq -n \
              --arg sl "$sonar_link" \
              --arg msg "$message" \
              '{
                "type": "doc",
                "version": 1,
                "content": [
                  {
                    "type": "paragraph",
                    "content": [
                      {"type": "text", "text": "1. Review the code at "},
                      {"type": "text", "text": $sl, "marks": [{"type": "link", "attrs": {"href": $sl}}]}
                    ]
                  },
                  {
                    "type": "paragraph",
                    "content": [{"type": "text", "text": ("2. Check the issue: " + $msg)}]
                  }
                ]
              }')
            
            expected_vs_actual=$(jq -n \
              --arg rule "$rule" \
              --arg msg "$message" \
              '{
                "type": "doc",
                "version": 1,
                "content": [
                  {
                    "type": "paragraph",
                    "content": [
                      {"type": "text", "text": "Expected: ", "marks": [{"type": "strong"}]},
                      {"type": "text", "text": ("Code should comply with " + $rule)}
                    ]
                  },
                  {
                    "type": "paragraph",
                    "content": [
                      {"type": "text", "text": "Actual: ", "marks": [{"type": "strong"}]},
                      {"type": "text", "text": $msg}
                    ]
                  }
                ]
              }')

            # Create Jira issue payload
            payload=$(jq -n \
              --arg proj "${JIRA_PROJECT_KEY}" \
              --arg summ "$summary" \
              --argjson desc "$description" \
              --arg prior "$priority" \
              --arg itype "$issue_type" \
              --arg sev "$jira_severity" \
              --arg env "$JIRA_ENV_OPTION" \
              --argjson steps "$steps_to_reproduce" \
              --argjson expected "$expected_vs_actual" \
              '{
                fields: {
                  project: {key: $proj},
                  summary: $summ,
                  description: $desc,
                  issuetype: {name: $itype},
                  priority: {name: $prior},
                  labels: [
                    "sonarcloud",
                    "automated",
                    ($itype|ascii_downcase)
                  ],
                  customfield_10041: $steps,
                  customfield_10042: {value: $sev},
                  customfield_10043: $expected,
                  customfield_10044: {value: $env},
                  customfield_10039: []
                }
              }')

            # --- STEP 1: CREATE JIRA ISSUE ---
            echo "  ðŸ“ Creating Jira issue for ${issue_key} (Severity: ${jira_severity})"
            
            create_resp=$(curl -s -w "\n%{http_code}" \
              -u "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
              -X POST \
              -H "Content-Type: application/json" \
              --data "$payload" \
              "https://${JIRA_HOST}/rest/api/3/issue" 2>/dev/null || echo "000")
            
            http_code=$(echo "$create_resp" | tail -n1)
            body=$(echo "$create_resp" | sed '$d')

            if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
              json_line=$(echo "$body" | grep -E '^{.*\}$')
              jira_key=$(echo "$json_line" | jq -r '.key // "unknown"')
              jira_url="https://${JIRA_HOST}/browse/${jira_key}"
              echo "  âœ… Created ${jira_key}: ${jira_url}"
              ((created++)) || true

              # --- STEP 2: CREATE LOCAL REPORT FILE ---
              TEMP_FILE="sonar_report_${issue_key}.txt"
              echo "SonarCloud Issue Details" > "$TEMP_FILE"
              echo "------------------------" >> "$TEMP_FILE"
              echo "Issue Key: $issue_key" >> "$TEMP_FILE"
              echo "Rule: $rule" >> "$TEMP_FILE"
              echo "Severity: $severity" >> "$TEMP_FILE"
              echo "Type: $type" >> "$TEMP_FILE"
              echo "File: $file:$line" >> "$TEMP_FILE"
              echo "Message: $message" >> "$TEMP_FILE"
              echo "SonarCloud Link: $sonar_link" >> "$TEMP_FILE"
              echo "  ðŸ“„ Created local attachment file: $TEMP_FILE"

              # --- STEP 3: ATTACH FILE TO JIRA ISSUE ---
              attach_resp=$(curl -s -w "\n%{http_code}" \
                -u "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
                -X POST \
                -H "X-Atlassian-Token: no-check" \
                -F "file=@$TEMP_FILE" \
                "https://${JIRA_HOST}/rest/api/3/issue/${jira_key}/attachments" 2>/dev/null || echo "000")
              
              attach_http_code=$(echo "$attach_resp" | tail -n1)
              
              if [ "$attach_http_code" -ge 200 ] && [ "$attach_http_code" -lt 300 ]; then
                echo "  ðŸ“Ž Attachment uploaded successfully (HTTP ${attach_http_code})"
              else
                echo "  âŒ Failed to upload attachment (HTTP ${attach_http_code})"
              fi
              
              # Clean up local file
              rm "$TEMP_FILE"

            else
              echo "  âŒ Failed to create Jira issue (HTTP ${http_code})"
              echo "$body" | grep -E '^{.*\}$' | jq '.' 2>/dev/null || echo "$body"
              ((failed++)) || true
            fi
            
            sleep 0.5
          done

          echo ""
          echo "=========================================="
          echo "âœ… Jira Issue Sync Complete"
          echo "=========================================="
          echo "Created: ${created}"
          echo "Skipped: ${skipped}"
          echo "Failed: ${failed}"
          echo "=========================================="
