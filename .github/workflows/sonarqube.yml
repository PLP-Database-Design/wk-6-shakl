name: SonarCloud analysis and create Jira issues

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis

      # FIX: Set up Java 17+ (required by SonarCloud)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Run SonarCloud analysis
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Needed for PR decoration
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=I-Macharia_wk-6-shakl
            -Dsonar.organization=i-macharia
            -Dsonar.sources=.
            -Dsonar.exclusions=**/node_modules/**,**/tests/**,**/*.test.js,**/*.spec.js
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info

  create-jira-issues:
    needs: analyze
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl python3

      - name: Fetch Sonar issues and create Jira issues
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_KEY: I-Macharia_wk-6-shakl
          JIRA_HOST: ${{ secrets.JIRA_HOST }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_PROJECT_KEY: ${{ secrets.JIRA_PROJECT_KEY }}
        run: |
          set -euo pipefail

          # Add delay to allow SonarCloud to process results
          echo "Waiting 30 seconds for SonarCloud to process analysis..."
          sleep 30

          SONAR_API="https://sonarcloud.io/api/issues/search?componentKeys=${SONAR_PROJECT_KEY}&resolved=false&types=VULNERABILITY,BUG,CODE_SMELL&ps=500"
          echo "Calling SonarCloud API for project ${SONAR_PROJECT_KEY}"
          issues_json=$(curl -s -u "${SONAR_TOKEN}:" "${SONAR_API}")

          # Check if curl was successful
          if [ $? -ne 0 ]; then
            echo "ERROR: Failed to fetch issues from SonarCloud"
            exit 1
          fi

          total=$(echo "$issues_json" | jq -r '.total // 0')
          echo "Found $total unresolved Sonar issues"

          if [ "$total" -eq 0 ]; then
            echo "No unresolved issues to create in Jira. Exiting."
            exit 0
          fi

          echo "$issues_json" | jq -c '.issues[]' | while IFS= read -r issue; do
            issue_key=$(echo "$issue" | jq -r '.key')
            rule=$(echo "$issue" | jq -r '.rule')
            severity=$(echo "$issue" | jq -r '.severity')
            comp=$(echo "$issue" | jq -r '.component')
            file=$(echo "$issue" | jq -r '.component' | sed 's/.*://')
            line=$(echo "$issue" | jq -r '.line // "n/a"')
            message=$(echo "$issue" | jq -r '.message' | sed 's/"/\\"/g')
            sonar_link="https://sonarcloud.io/project/issues?id=${SONAR_PROJECT_KEY}&open=${issue_key}"

            summary="[SonarCloud] ${severity}: ${rule} in ${file}:${line}"
            description="*SonarCloud Issue:* ${issue_key}\n\n*Rule:* ${rule}\n*Severity:* ${severity}\n*Component:* ${comp}\n*Line:* ${line}\n\n*Message:*\n{quote}${message}{quote}\n\n*Sonar Link:* ${sonar_link}"

            # URL encode the issue key for JQL query
            jql=$(printf 'summary ~~ "%s"' "$issue_key" | python3 -c "import sys, urllib.parse; print(urllib.parse.quote(sys.stdin.read()))")

            search_url="https://${JIRA_HOST}/rest/api/3/search?jql=${jql}&fields=key"
            existing=$(curl -s -u "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" -H "Accept: application/json" "${search_url}")

            existing_total=$(echo "$existing" | jq -r '.total // 0')
            if [ "$existing_total" != "0" ]; then
              existing_key=$(echo "$existing" | jq -r '.issues[0].key')
              echo "✓ Jira issue ${existing_key} already exists for Sonar issue ${issue_key}; skipping creation."
              continue
            fi

            # Map SonarCloud severity to Jira priority
            case "$severity" in
              CRITICAL|BLOCKER)
                priority="Highest"
                ;;
              MAJOR)
                priority="High"
                ;;
              MINOR)
                priority="Medium"
                ;;
              INFO)
                priority="Low"
                ;;
              *)
                priority="Medium"
                ;;
            esac

            # Create Jira issue with proper formatting
            payload=$(jq -n \
              --arg proj "${JIRA_PROJECT_KEY}" \
              --arg summ "$summary" \
              --arg desc "$description" \
              --arg prior "$priority" \
              '{
                fields: {
                  project: {key: $proj},
                  summary: $summ,
                  description: {
                    type: "doc",
                    version: 1,
                    content: [
                      {
                        type: "paragraph",
                        content: [
                          {type: "text", text: $desc}
                        ]
                      }
                    ]
                  },
                  issuetype: {name: "Bug"},
                  priority: {name: $prior},
                  labels: ["sonarcloud", "automated"]
                }
              }')

            echo "Creating Jira issue for Sonar issue ${issue_key} (severity: ${severity})"
            create_resp=$(curl -s -w "\n%{http_code}" \
              -u "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
              -X POST \
              -H "Content-Type: application/json" \
              --data "$payload" \
              "https://${JIRA_HOST}/rest/api/3/issue")
            
            http_code=$(echo "$create_resp" | tail -n1)
            body=$(echo "$create_resp" | sed '$d')

            if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
              jira_key=$(echo "$body" | jq -r '.key')
              echo "✓ Created Jira issue ${jira_key} for Sonar issue ${issue_key}"
            else
              echo "✗ Failed to create Jira issue for ${issue_key}: HTTP ${http_code}"
              echo "$body" | jq '.' || echo "$body"
            fi
          done

          echo ""
          echo "Jira issue creation process completed."
