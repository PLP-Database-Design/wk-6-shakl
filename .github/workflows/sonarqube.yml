name: SonarCloud analysis and create Jira issues

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  analyze:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis

      - name: Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      # Use v3 for latest features and Java 17 support
      - name: Run SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=I-Macharia_wk-6-shakl
            -Dsonar.organization=i-macharia
            -Dsonar.sources=src,public
            -Dsonar.tests=tests
            -Dsonar.exclusions=**/node_modules/**,**/build/**,**/dist/**,**/coverage/**,**/*.test.js,**/*.spec.js
            -Dsonar.test.exclusions=**/node_modules/**,**/*.test.js,**/*.spec.js
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
            -Dsonar.qualitygate.wait=true


  create-jira-issues:
    name: Create Jira Issues
    needs: analyze
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Wait for SonarCloud processing
        run: |
          echo "Waiting 45 seconds for SonarCloud to process analysis results..."
          sleep 45

      - name: Fetch SonarCloud issues and create Jira tickets
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_KEY: I-Macharia_wk-6-shakl
          JIRA_HOST: ${{ secrets.JIRA_HOST }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_PROJECT_KEY: ${{ secrets.JIRA_PROJECT_KEY }}
        run: |
          set -euo pipefail

          echo "=========================================="
          echo "SonarCloud to Jira Issue Sync"
          echo "=========================================="
          echo "Project: ${SONAR_PROJECT_KEY}"
          echo "Jira Project: ${JIRA_PROJECT_KEY}"
          echo ""

          # Fetch issues from SonarCloud
          SONAR_API="https://sonarcloud.io/api/issues/search"
          PARAMS="componentKeys=${SONAR_PROJECT_KEY}&resolved=false&types=VULNERABILITY,BUG,CODE_SMELL&ps=500"
          
          echo "üìä Fetching issues from SonarCloud..."
          issues_json=$(curl -s -u "${SONAR_TOKEN}:" "${SONAR_API}?${PARAMS}")

          # Check for API errors
          if echo "$issues_json" | jq -e '.errors' > /dev/null 2>&1; then
            echo "‚ùå SonarCloud API Error:"
            echo "$issues_json" | jq '.errors'
            exit 1
          fi

          total=$(echo "$issues_json" | jq -r '.total // 0')
          echo "‚úì Found $total unresolved SonarCloud issues"
          echo ""

          if [ "$total" -eq 0 ]; then
            echo "‚úÖ No unresolved issues found. Exiting successfully."
            exit 0
          fi

          # Process each issue
          created=0
          skipped=0
          failed=0

          echo "$issues_json" | jq -c '.issues[]' | while IFS= read -r issue; do
            issue_key=$(echo "$issue" | jq -r '.key')
            rule=$(echo "$issue" | jq -r '.rule')
            severity=$(echo "$issue" | jq -r '.severity')
            type=$(echo "$issue" | jq -r '.type')
            comp=$(echo "$issue" | jq -r '.component')
            file=$(echo "$issue" | jq -r '.component' | sed 's/.*://')
            line=$(echo "$issue" | jq -r '.line // "n/a"')
            message=$(echo "$issue" | jq -r '.message')
            
            # Create SonarCloud issue link
            sonar_link="https://sonarcloud.io/project/issues?id=${SONAR_PROJECT_KEY}&open=${issue_key}"

            # Create Jira summary and description
            summary="[SonarCloud ${type}] ${severity}: ${rule} in ${file}"
            
            # Jira description in Atlassian Document Format
            description=$(cat <<EOF
            {
              "type": "doc",
              "version": 1,
              "content": [
            {
                "type": "heading",
                "attrs": {"level": 3},
                "content": [{"type": "text", "text": "SonarCloud Issue Details"}]
                },
           {
                "type": "paragraph",
                 "content": [
                {"type": "text", "text": "Issue Key: ", "marks": [{"type": "strong"}]},
                {"type": "text", "text": "${issue_key}"}
                  ]
                  },
          {
                "type": "paragraph",
                 "content": [
                {"type": "text", "text": "Rule: ", "marks": [{"type": "strong"}]},
                {"type": "text", "text": "${rule}"}
                  ]
                  },
          {
                "type": "paragraph",
                "content": [
                {"type": "text", "text": "Severity: ", "marks": [{"type": "strong"}]},
                {"type": "text", "text": "${severity}"}
                ]
                },
          {
              "type": "paragraph",
              "content": [
              {"type": "text", "text": "Type: ", "marks": [{"type": "strong"}]},
              {"type": "text", "text": "${type}"}
                ]
                },
          {
              "type": "paragraph",
              "content": [
              {"type": "text", "text": "File: ", "marks": [{"type": "strong"}]},
              {"type": "text", "text": "${file}:${line}"}
                ]
                },
          {
            "type": "heading",
            "attrs": {"level": 3},
            "content": [{"type": "text", "text": "Issue Description"}]
              },
              {
              "type": "paragraph",
              "content": [{"type": "text", "text": "${message}"}]
            },
          {
            "type": "paragraph",
            "content": [
            {"type": "text", "text": "View in SonarCloud: ", "marks": [{"type": "strong"}]},
            {
              "type": "text",
              "text": "${sonar_link}",
              "marks": [{"type": "link", "attrs": {"href": "${sonar_link}"}}]
            }
                ]
                }
                ]
                }
                EOF
                    )

            # Check if Jira issue already exists
            search_jql=$(printf 'text ~ "%s" ORDER BY created DESC' "$issue_key" | jq -sRr @uri)
            search_url="https://${JIRA_HOST}/rest/api/3/search?jql=${search_jql}&fields=key,summary"
            
            existing=$(curl -s -u "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
              -H "Accept: application/json" \
              "${search_url}" 2>/dev/null || echo '{"total":0}')

            existing_total=$(echo "$existing" | jq -r '.total // 0')
            
            if [ "$existing_total" != "0" ]; then
              existing_key=$(echo "$existing" | jq -r '.issues[0].key // "unknown"')
              echo "  ‚è≠Ô∏è  Jira issue ${existing_key} exists for ${issue_key} - skipping"
              ((skipped++)) || true
              continue
            fi

            # Map SonarCloud severity to Jira priority
            case "$severity" in
              BLOCKER|CRITICAL)
                priority="Highest"
                ;;
              MAJOR)
                priority="High"
                ;;
              MINOR)
                priority="Medium"
                ;;
              INFO)
                priority="Low"
                ;;
              *)
                priority="Medium"
                ;;
            esac

            # Map SonarCloud type to Jira issue type
            case "$type" in
              BUG)
                issue_type="Bug"
                ;;
              VULNERABILITY)
                issue_type="Bug"
                ;;
              CODE_SMELL)
                issue_type="Task"
                ;;
              *)
                issue_type="Bug"
                ;;
            esac

            # Create Jira issue payload
            payload=$(jq -n \
              --arg proj "${JIRA_PROJECT_KEY}" \
              --arg summ "$summary" \
              --argjson desc "$description" \
              --arg prior "$priority" \
              --arg itype "$issue_type" \
              '{
                fields: {
                  project: {key: $proj},
                  summary: $summ,
                  description: $desc,
                  issuetype: {name: $itype},
                  priority: {name: $prior},
                  labels: [
                  "sonarcloud",
                  "automated",
                  "${type,,}"
                  ]
                }
              }')

            # Create Jira issue
            echo "  üìù Creating Jira issue for ${issue_key} (${severity} ${type})"
            
            create_resp=$(curl -s -w "\n%{http_code}" \
              -u "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
              -X POST \
              -H "Content-Type: application/json" \
              --data "$payload" \
              "https://${JIRA_HOST}/rest/api/3/issue" 2>/dev/null || echo "000")
            
            http_code=$(echo "$create_resp" | tail -n1)
            body=$(echo "$create_resp" | sed '$d')

            if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
              jira_key=$(echo "$body" | jq -r '.key // "unknown"')
              jira_url="https://${JIRA_HOST}/browse/${jira_key}"
              echo "  ‚úÖ Created ${jira_key}: ${jira_url}"
              ((created++)) || true
            else
              echo "  ‚ùå Failed to create Jira issue (HTTP ${http_code})"
              echo "$body" | jq '.' 2>/dev/null || echo "$body"
              ((failed++)) || true
            fi
            
            # Rate limiting: small delay between requests
            sleep 0.5
          done

          echo ""
          echo "=========================================="
          echo "‚úÖ Jira Issue Sync Complete"
          echo "=========================================="
          echo "Created: ${created}"
          echo "Skipped: ${skipped}"
          echo "Failed: ${failed}"
          echo "=========================================="
